<div class="w-full max-w-xl mx-auto flex flex-col items-center">
    <!-- Header -->
    <div class="w-full flex justify-between items-center mb-4 px-2">
        <h2 class="font-medieval text-5xl text-amber-400">Arena</h2>
        <button (click)="exit.emit()" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-lg transition-colors">
            Sair
        </button>
    </div>

    <!-- Arena Board -->
    <div #arenaBoard (click)="playCardOnArena($event)"
         class="w-full aspect-[9/12] border-4 border-yellow-800 rounded-lg relative overflow-hidden shadow-2xl"
         [class.cursor-copy]="selectedCardIndex() !== null && gameStatus() === 'playing'"
         style="background-image: url('https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/bg.jpg'); background-size: cover;">
        
        <!-- River -->
        <div class="absolute top-1/2 left-0 w-full h-12 bg-blue-500/80 -translate-y-1/2 border-y-4 border-blue-300/50 backdrop-blur-sm"></div>
        <img src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/bridge.png" alt="Bridge" class="absolute top-1/2 left-1/4 w-16 h-auto -translate-y-1/2">
        <img src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/bridge.png" alt="Bridge" class="absolute top-1/2 right-1/4 w-16 h-auto -translate-y-1/2">

        <!-- Towers -->
        <!-- Enemy Towers -->
        <div class="absolute" [style.left.px]="TOWER_POSITIONS.enemy.king.x" [style.top.px]="TOWER_POSITIONS.enemy.king.y" style="transform: translate(-50%, -60%); width: 100px;">
             <img src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/tower_red_king.png" alt="Enemy King Tower" class="w-full h-auto" [class.damage-flash]="towerFlashing().enemy.king">
             <div class="absolute -bottom-5 w-full text-center font-medieval text-lg text-white bg-red-900/80 rounded px-1 border border-red-500">{{ towerHP().enemy.king }}</div>
        </div>
        <div class="absolute" [style.left.px]="TOWER_POSITIONS.enemy.left.x" [style.top.px]="TOWER_POSITIONS.enemy.left.y" style="transform: translate(-50%, -55%); width: 80px;">
             <img src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/tower_red_princess.png" alt="Enemy Princess Tower" class="w-full h-auto" [class.damage-flash]="towerFlashing().enemy.left">
             <div class="absolute -bottom-4 w-full text-center font-medieval text-base text-white bg-red-900/80 rounded px-1 border border-red-500">{{ towerHP().enemy.left }}</div>
        </div>
         <div class="absolute" [style.left.px]="TOWER_POSITIONS.enemy.right.x" [style.top.px]="TOWER_POSITIONS.enemy.right.y" style="transform: translate(-50%, -55%); width: 80px;">
             <img src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/tower_red_princess.png" alt="Enemy Princess Tower" class="w-full h-auto" [class.damage-flash]="towerFlashing().enemy.right">
             <div class="absolute -bottom-4 w-full text-center font-medieval text-base text-white bg-red-900/80 rounded px-1 border border-red-500">{{ towerHP().enemy.right }}</div>
        </div>
        
        <!-- Player Towers -->
        <div class="absolute" [style.left.px]="TOWER_POSITIONS.player.king.x" [style.top.px]="TOWER_POSITIONS.player.king.y" style="transform: translate(-50%, -60%); width: 100px;">
             <img src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/tower_blue_king.png" alt="Player King Tower" class="w-full h-auto" [class.damage-flash]="towerFlashing().player.king">
             <div class="absolute -bottom-5 w-full text-center font-medieval text-lg text-white bg-blue-900/80 rounded px-1 border border-blue-400">{{ towerHP().player.king }}</div>
        </div>
        <div class="absolute" [style.left.px]="TOWER_POSITIONS.player.left.x" [style.top.px]="TOWER_POSITIONS.player.left.y" style="transform: translate(-50%, -55%); width: 80px;">
             <img src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/tower_blue_princess.png" alt="Player Princess Tower" class="w-full h-auto" [class.damage-flash]="towerFlashing().player.left">
             <div class="absolute -bottom-4 w-full text-center font-medieval text-base text-white bg-blue-900/80 rounded px-1 border border-blue-400">{{ towerHP().player.left }}</div>
        </div>
         <div class="absolute" [style.left.px]="TOWER_POSITIONS.player.right.x" [style.top.px]="TOWER_POSITIONS.player.right.y" style="transform: translate(-50%, -55%); width: 80px;">
             <img src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/arena/tower_blue_princess.png" alt="Player Princess Tower" class="w-full h-auto" [class.damage-flash]="towerFlashing().player.right">
             <div class="absolute -bottom-4 w-full text-center font-medieval text-base text-white bg-blue-900/80 rounded px-1 border border-blue-400">{{ towerHP().player.right }}</div>
        </div>

        <!-- Active Troops -->
        @for (troop of activeTroops(); track troop.id) {
            <app-troop [troop]="troop" />
        }

        <!-- Spell Effects -->
        @for (effect of spellEffects(); track effect.id) {
            <div class="spell-explosion" 
                 [style.left.px]="effect.position.x" 
                 [style.top.px]="effect.position.y"
                 [style.width.px]="effect.card.radius! * 2"
                 [style.height.px]="effect.card.radius! * 2"
                 [style.transform]="'translate(-50%, -50%)'"
                 [style.background-color]="effect.card.id === 'fireball' ? 'rgba(255, 165, 0, 0.7)' : 'rgba(138, 43, 226, 0.6)'"
                 [style.border]="'4px solid ' + (effect.card.id === 'fireball' ? 'rgba(255, 69, 0, 0.8)' : 'rgba(75, 0, 130, 0.8)')"
                 >
            </div>
        }

        <!-- Game Over Overlay -->
        @if (gameStatus() !== 'playing') {
          <div class="absolute inset-0 bg-black/70 flex flex-col items-center justify-center z-50 animate-fade-in">
            <h2 class="font-medieval text-8xl" [class.text-green-400]="gameStatus() === 'win'" [class.text-red-500]="gameStatus() === 'lose'">
              @if(gameStatus() === 'win') { Vit√≥ria! }
              @if(gameStatus() === 'lose') { Derrota! }
            </h2>
            <button (click)="exit.emit()" class="mt-8 bg-amber-500 hover:bg-amber-600 font-bold py-3 px-6 rounded-lg transition-colors text-2xl font-medieval">
              Voltar ao Deck
            </button>
          </div>
        }
    </div>

    <!-- Player Hand & Elixir -->
    <div class="w-full mt-4">
        <!-- Elixir Bar -->
        <div class="h-6 w-full max-w-sm mx-auto bg-gray-700 rounded-full flex items-center p-1 border-2 border-fuchsia-400/50 mb-4">
            <div class="h-full bg-fuchsia-500 rounded-full transition-all duration-200" [style.width.%]="(elixir() / 10) * 100"></div>
            <span class="absolute w-full text-center font-bold text-white drop-shadow-md">{{ displayElixir() }} / 10</span>
        </div>
        
        <!-- Hand -->
        <div class="flex justify-center items-end gap-2 h-44">
            @for (card of playerHand(); track $index) {
                <div (click)="selectCard(card, $index)"
                     class="w-24 transition-all duration-200"
                     [class.border-4]="selectedCardIndex() === $index"
                     [class.border-yellow-300]="selectedCardIndex() === $index"
                     [class.-translate-y-4]="selectedCardIndex() === $index"
                     [class.opacity-50]="elixir() < card.elixirCost && selectedCardIndex() !== $index">
                    <app-card [card]="card" />
                </div>
            }
        </div>
    </div>
</div>