<!-- Main container simulating a mobile screen -->
<div
  class="w-full max-w-md mx-auto h-screen bg-slate-900 shadow-2xl shadow-black flex flex-col relative"
>
  <!-- Main content -->
  <main class="flex-grow overflow-y-auto pb-24">
    @if (!showArena()) {
      @switch (currentView()) {
        @case ('main') {
          <!-- Main Menu View -->
          <div class="h-full relative">
            <div
              class="absolute inset-0 bg-cover bg-center opacity-20"
              style="background-image: url('https://static.vecteezy.com/system/resources/previews/009/607/589/large_2x/fantasy-castle-on-the-hill-cartoon-background-vector.jpg');"
            ></div>
            <div
              class="absolute inset-0 bg-gradient-to-b from-slate-900/80 via-slate-900/60 to-slate-900/80"
            ></div>

            <div class="relative z-10 flex flex-col h-full p-4">
              <!-- User Info -->
              <header
                class="w-full bg-slate-800/50 rounded-2xl p-4 border border-slate-700 shadow-lg backdrop-blur-sm"
              >
                <div class="flex items-center gap-4">
                  <img
                    src="https://picsum.photos/seed/user/100/100"
                    class="w-16 h-16 rounded-full border-4 border-amber-400"
                  />
                  <div>
                    <h1 class="font-medieval text-3xl text-white">
                      {{ user().name }}
                    </h1>
                    <div class="text-amber-300 font-bold">
                      Nível {{ user().level }}
                    </div>
                  </div>
                </div>

                <!-- XP Bar -->
                <div class="mt-4">
                  <div
                    class="w-full bg-gray-700 rounded-full h-4 border border-slate-600 overflow-hidden"
                  >
                    <div
                      class="bg-gradient-to-r from-sky-500 to-cyan-400 h-full rounded-full"
                      [style.width.%]="(user().xp / user().xpForNextLevel) * 100"
                    ></div>
                  </div>
                  <div class="text-center text-sm text-slate-300 mt-1">
                    {{ user().xp }} / {{ user().xpForNextLevel }} XP
                  </div>
                </div>

                <!-- Gold & Trophies -->
                <div class="mt-4 grid grid-cols-2 gap-2">
                  <div
                    class="flex items-center gap-2 justify-center bg-gray-900/50 p-2 rounded-lg border border-slate-600"
                  >
                    <img
                      src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/icons/gold.png"
                      class="w-8 h-8"
                    />
                    <span
                      class="font-medieval text-2xl text-yellow-400"
                    >
                      {{ user().gold }}
                    </span>
                  </div>
                  <div
                    class="flex items-center gap-2 justify-center bg-gray-900/50 p-2 rounded-lg border border-slate-600"
                  >
                    <img
                      src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/icons/trophy.png"
                      class="w-8 h-8"
                    />
                    <span
                      class="font-medieval text-2xl text-amber-500"
                    >
                      {{ user().trophies }}
                    </span>
                  </div>
                </div>
              </header>

              <!-- Game Modes -->
              <div class="flex-grow flex flex-col items-center justify-center py-6">
                <h2 class="font-medieval text-3xl text-amber-300 mb-4">
                  Modos de Jogo
                </h2>

                <button
                  (click)="openClassicChallenge()"
                  class="font-medieval text-2xl py-3 px-10 rounded-xl transition-all duration-300 shadow-lg bg-gradient-to-r from-yellow-600 to-orange-700 hover:scale-105 text-white w-full max-w-xs mb-4"
                >
                  Desafio Clássico
                </button>

                <button
                  (click)="enterArena()"
                  [disabled]="!isDeckFull()"
                  class="font-medieval text-4xl py-4 px-12 rounded-2xl transition-all duration-300 shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed w-full max-w-xs"
                  [ngClass]="
                    isDeckFull()
                      ? 'bg-gradient-to-r from-green-500 to-emerald-600 hover:scale-105 text-white'
                      : 'bg-gray-700 text-gray-400'
                  "
                >
                  Batalha Padrão
                </button>
                @if (!isDeckFull()) {
                  <p class="text-center text-sm mt-3 text-slate-400">
                    Complete seu deck para batalhar.
                  </p>
                }
              </div>


              <!-- Trophy Road -->
              <div class="w-full">
                <h3
                  class="font-medieval text-2xl text-amber-300 mb-3 text-center"
                >
                  Caminho dos Troféus
                </h3>
                <div
                  class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 backdrop-blur-sm"
                >
                  <div
                    class="flex items-center justify-between text-center mb-2"
                  >
                    <!-- Previous Reward -->
                    <div class="w-1/4">
                      @if (previousTrophyReward(); as prev) {
                        <img
                          [src]="prev.reward.imageUrl"
                          [alt]="prev.reward.name"
                          class="w-12 h-12 mx-auto drop-shadow-lg"
                        />
                        <div class="text-xs text-slate-400">
                          {{ prev.trophiesRequired }}
                        </div>
                      }
                    </div>

                    <!-- Next Reward -->
                    <div class="w-1/4">
                      @if (nextTrophyReward(); as next) {
                        <img
                          [src]="next.reward.imageUrl"
                          [alt]="next.reward.name"
                          class="w-16 h-16 mx-auto drop-shadow-lg opacity-75 grayscale"
                        />
                        <div class="text-sm font-bold text-slate-200">
                          {{ next.trophiesRequired }}
                        </div>
                      }
                    </div>
                  </div>

                  <!-- Progress Bar -->
                  <div
                    class="relative w-full bg-gray-900 rounded-full h-6 border-2 border-slate-600 overflow-hidden"
                  >
                    <div
                      class="bg-gradient-to-r from-amber-500 to-yellow-400 h-full rounded-full"
                      [style.width.%]="trophyProgressPercent()"
                    ></div>
                    <div
                      class="absolute inset-0 flex items-center justify-center"
                    >
                      <img
                        src="https://cdn.jsdelivr.net/gh/rodolfo-s/rpg-deck-builder-assets@main/icons/trophy.png"
                        class="w-5 h-5 mr-1"
                      />
                      <span
                        class="font-bold text-sm text-white drop-shadow-md"
                      >
                        {{ user().trophies }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
        @case ('collection') {
          <!-- Card Collection View -->
          <div class="grid grid-cols-1 gap-8 p-4">
            <!-- Card Collection -->
            <div
              class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700 shadow-2xl"
            >
              <div class="h-[75vh] overflow-y-auto pr-2">
                @for (group of groupedCards(); track group.rarity) {
                  <section class="mb-8">
                    <h2
                      class="font-medieval text-3xl mb-4 text-slate-300 border-b-2 border-slate-700 pb-2"
                    >
                      {{ group.rarity }}
                    </h2>
                    <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                      @for (card of group.cards; track card.id) {
                        <div
                          (click)="openCardDetail(card)"
                          [class.opacity-50]="isCardInDeck(card)"
                        >
                          <app-card [card]="card" />
                        </div>
                      }
                    </div>
                  </section>
                }
              </div>
            </div>

            <!-- User Deck -->
            <div
              class="bg-slate-800/50 rounded-2xl p-6 border border-slate-700 shadow-2xl sticky top-0"
            >
              <div>
                <h2
                  class="font-medieval text-4xl text-rose-400 mb-4"
                >
                  Seus Decks
                </h2>

                <!-- Deck Selector -->
                <div
                  class="flex justify-center mb-4 bg-gray-900 rounded-lg p-1 border border-slate-600"
                >
                  @for (deck of decks(); track $index) {
                    <button
                      (click)="selectDeck($index)"
                      class="flex-1 font-bold py-2 px-4 rounded-md transition-colors"
                      [class.bg-blue-600]="selectedDeckIndex() === $index"
                      [class.text-white]="selectedDeckIndex() === $index"
                      [class.text-slate-400]="selectedDeckIndex() !== $index"
                    >
                      Deck {{ $index + 1 }}
                    </button>
                  }
                </div>

                <div
                  class="bg-gray-900/70 rounded-lg p-3 mb-4 flex justify-between items-center border border-slate-600"
                >
                  <span class="text-slate-300 font-bold">
                    Custo Médio de Elixir:
                  </span>
                  <span
                    class="font-medieval text-3xl text-fuchsia-400"
                  >
                    {{ averageElixir() }}
                  </span>
                </div>

                <div class="grid grid-cols-4 gap-2 mb-6">
                  @for (card of currentDeck(); track $index) {
                    @if (card) {
                      <div (click)="removeCardFromDeck($index)">
                        <app-card [card]="card" />
                      </div>
                    } @else {
                      <div
                        class="aspect-[3/4] bg-slate-900/50 border-2 border-dashed border-slate-600 rounded-lg flex items-center justify-center"
                      ></div>
                    }
                  }
                </div>
                <p class="text-center text-sm mt-2 text-slate-400">
                  Toque em um cartão para removê-lo.
                </p>
              </div>
            </div>
          </div>
        }
        @case ('guild') {
          @if (user().guildId) {
            <app-guild-view />
          } @else {
            <app-guild-hub />
          }
        }
      }
    } @else {
      <app-arena [deck]="currentDeck()" (exit)="exitArena()" />
    }
  </main>

  <!-- Bottom Navigation -->
  @if (!showArena()) {
    <nav
      class="absolute bottom-0 left-0 right-0 bg-slate-900/80 backdrop-blur-sm border-t border-slate-700 p-2 flex justify-around z-30"
    >
      <button
        (click)="currentView.set('main')"
        class="nav-button"
        [class.active]="currentView() === 'main'"
      >
        <span>Batalha</span>
      </button>
      <button
        (click)="currentView.set('collection')"
        class="nav-button"
        [class.active]="currentView() === 'collection'"
      >
        <span>Cartas</span>
      </button>
       <button
        (click)="currentView.set('guild')"
        class="nav-button"
        [class.active]="currentView() === 'guild'"
      >
        <span>Guilda</span>
      </button>
    </nav>
  }
</div>

<!-- Card Detail Modal -->
@if (selectedCardForDetail(); as card) {
  <div class="w-full max-w-md mx-auto h-screen flex flex-col relative">
    <app-card-detail
      [card]="card"
      (close)="closeCardDetail()"
      (useCard)="confirmAddToDeck($event)"
    />
  </div>
}

<!-- Classic Challenge Modal -->
@if (showClassicChallenge()) {
  <app-classic-challenge
    [points]="user().classicPoints ?? 0"
    (close)="closeClassicChallenge()"
  />
}
